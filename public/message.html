<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Ultra Call - Messages</title>
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
<style>
/* style moderne sombre */
*{box-sizing:border-box}
body,html{margin:0;padding:0;height:100%;font-family:"Segoe UI",system-ui,-apple-system,Roboto,"Helvetica Neue",Arial;color:#fff;background:linear-gradient(135deg,#0b0b0f 0%,#13131a 100%);}
header{display:flex;align-items:center;justify-content:space-between;padding:16px 24px;background:rgba(7,10,20,0.6);backdrop-filter:blur(6px);border-bottom:1px solid rgba(255,255,255,0.03)}
.logo{display:flex;align-items:center;gap:10px;font-weight:700;font-size:20px;color:#4e8cff}
.logo .badge{background:linear-gradient(90deg,#6fb3ff,#3a6fdc);padding:8px;border-radius:10px;display:inline-flex;align-items:center;justify-content:center;width:36px;height:36px}
.nav{display:flex;gap:12px;align-items:center}
.nav span{padding:6px 10px;border-radius:8px;cursor:pointer}
.nav .active{background:#162b4b;color:#fff}
.nav .coming{color:#7b8794}

/* container */
.container{max-width:1100px;margin:28px auto;padding:20px;display:flex;gap:24px;align-items:flex-start;height:calc(100vh - 100px);}
.col{flex:1;display:flex;flex-direction:column}

/* card */
.card{background:linear-gradient(180deg,rgba(255,255,255,0.03),rgba(255,255,255,0.02));padding:18px;border-radius:14px;border:1px solid rgba(255,255,255,0.03);flex:1;overflow:auto}

/* amis */
#friendsList{display:flex;flex-direction:column;gap:12px}
.friend{padding:12px;border-radius:10px;background:#0f1720;border:1px solid rgba(255,255,255,0.06);cursor:pointer;display:flex;align-items:center;gap:10px}
.friend:hover{background:#162b4b}
.friend.active{background:#162b4b;color:#fff}

/* chat */
#chatWindow{display:flex;flex-direction:column;gap:10px;height:100%}
.messages{flex:1;overflow-y:auto;padding:10px;display:flex;flex-direction:column;gap:8px}
.msg{max-width:70%;padding:10px 14px;border-radius:12px;line-height:1.4}
.msg.me{align-self:flex-end;background:#4e8cff;color:#041a34}
.msg.them{align-self:flex-start;background:#0f1720;color:#fff;border:1px solid rgba(255,255,255,0.05)}
.inputRow{display:flex;gap:10px;margin-top:auto}
.inputRow input{flex:1;padding:12px;border-radius:10px;border:1px solid rgba(255,255,255,0.06);background:#0f1720;color:#fff}
.inputRow button{padding:12px 16px;border-radius:10px;background:#4e8cff;color:#041a34;border:none;cursor:pointer}

/* loader */
#loader {
  position:fixed;
  top:0;left:0;width:100%;height:100%;
  background:linear-gradient(135deg,#0b0b0f 0%,#13131a 100%);
  display:flex;flex-direction:column;align-items:center;justify-content:center;
  color:#4e8cff;font-size:24px;z-index:2000;
}
#loader i { font-size:50px; margin-bottom:20px; animation: spin 1.5s linear infinite; }
@keyframes spin { 0%{transform:rotate(0deg);}100%{transform:rotate(360deg);} }

@media(max-width:800px){
  .container{flex-direction:column;height:auto}
}
</style>
</head>
<body>

<!-- écran de chargement -->
<div id="loader"><i class="fa fa-spinner"></i> Chargement...</div>

<header style="display:none">
  <div class="logo"><div class="badge"><i class="fa fa-phone"></i></div>Ultra Call</div>
  <div class="nav">
    <span onclick="window.location.href='index.html'">Appels</span>
    <span class="active">Messages</span>
  </div>
</header>

<main class="container" style="display:none">
  <!-- Liste d'amis -->
  <aside class="col card" style="flex:0.35">
    <h3>Amis</h3>
    <div id="friendsList"></div>
  </aside>

  <!-- Fenêtre de chat -->
  <section class="col card" style="flex:0.65">
    <div id="chatWindow">
      <div class="messages" id="messages"></div>
      <div class="inputRow">
        <input id="messageInput" type="text" placeholder="Écris ton message..." />
        <button id="sendBtn"><i class="fa fa-paper-plane"></i></button>
      </div>
    </div>
  </section>
</main>

<script>
let ws = null;
let currentFriend = null;
const myCode = localStorage.getItem('myCode'); // récupère ton code automatiquement
if (!myCode) {
  alert("Aucun code trouvé, retourne sur l'accueil !");
  window.location.href = 'index.html';
}
// récupère la liste d'amis
let friendsArray = JSON.parse(localStorage.getItem('friendsList') || '[]');

const friendsListKey = 'friendsList';

function initWebSocket() {
  ws = new WebSocket(`ws://${location.host}/ws`);
  ws.onopen = () => ws.send(JSON.stringify({ cmd: 'register', code: myCode }));
  ws.onmessage = (e) => {
    const data = JSON.parse(e.data);
    if (data.type === 'message') {
      // si la conversation ouverte est celle de l'expéditeur
      if (data.from === currentFriend) {
        addMessageToChat('them', data.message);
      }
      // sinon on peut mettre une notif ou badge
      saveMessage(data.from, 'them', data.message);
    }
    if (data.type === 'friends-list') renderFriends(data.friends);
  };
}

// ---------------- FRIENDS ----------------
function renderFriends(list) {
  const friendsDiv = document.getElementById('friendsList');
  if (!list) list = friendsArray; // récupéré depuis localStorage
  friendsDiv.innerHTML = '';
  if (list.length === 0) friendsDiv.innerHTML = '<div class="small">Aucun ami</div>';
  list.forEach(f => {
    const div = document.createElement('div');
    div.className = 'friend' + (f === currentFriend ? ' active' : '');
    div.textContent = f;
    div.onclick = () => openChat(f);
    friendsDiv.appendChild(div);
  });
}


// ---------------- CHAT ----------------
function openChat(friend) {
  currentFriend = friend;
  loadChat();
  renderFriends(); // met à jour la couleur du bouton
}

function loadChat() {
  const messagesDiv = document.getElementById('messages');
  messagesDiv.innerHTML = '';
  if (!currentFriend) { messagesDiv.innerHTML = '<div class="small">Choisis un ami</div>'; return; }
  const conv = JSON.parse(localStorage.getItem('chat_' + currentFriend) || '[]');
  conv.forEach(m => addMessageToChat(m.from, m.text));
}

function addMessageToChat(from, text) {
  const messagesDiv = document.getElementById('messages');
  const div = document.createElement('div');
  div.className = 'msg ' + from;
  div.textContent = text;
  messagesDiv.appendChild(div);
  messagesDiv.scrollTop = messagesDiv.scrollHeight;
}

// sauvegarde localStorage
function saveMessage(friend, from, text) {
  const conv = JSON.parse(localStorage.getItem('chat_' + friend) || '[]');
  conv.push({ from, text });
  localStorage.setItem('chat_' + friend, JSON.stringify(conv));
}

// envoyer message
document.getElementById('sendBtn').addEventListener('click', sendMessage);
document.getElementById('messageInput').addEventListener('keypress', e => { if (e.key === 'Enter') sendMessage(); });

function sendMessage() {
  const input = document.getElementById('messageInput');
  const txt = input.value.trim();
  if (!txt || !currentFriend) return;
  addMessageToChat('me', txt);
  saveMessage(currentFriend, 'me', txt);

  // envoi au serveur
  if (ws && ws.readyState === WebSocket.OPEN) {
    ws.send(JSON.stringify({ cmd: 'message', target: currentFriend, message: txt, from: myCode }));
  }
  input.value = '';
}

// init page
window.addEventListener('load', () => {
  setTimeout(() => {
    document.getElementById('loader').style.display = 'none';
    document.querySelector('header').style.display = 'flex';
    document.querySelector('main').style.display = 'flex';
    currentFriend = localStorage.getItem('currentChat');
    initWebSocket();
    renderFriends();
    loadChat();
  }, 600);
});
</script>
  
</body>
</html>
