<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Ultra Call</title>
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
<style>
/* ======= ton CSS existant (inchangé) ======= */
*{box-sizing:border-box}
body,html{margin:0;padding:0;height:100%;font-family:"Segoe UI",system-ui,-apple-system,Roboto,"Helvetica Neue",Arial;color:#fff;background:linear-gradient(135deg,#0b0b0f 0%,#13131a 100%);}
header{display:flex;align-items:center;justify-content:space-between;padding:16px 24px;background:rgba(7,10,20,0.6);backdrop-filter:blur(6px);border-bottom:1px solid rgba(255,255,255,0.03)}
.logo{display:flex;align-items:center;gap:10px;font-weight:700;font-size:20px;color:#4e8cff}
.logo .badge{background:linear-gradient(90deg,#6fb3ff,#3a6fdc);padding:8px;border-radius:10px;display:inline-flex;align-items:center;justify-content:center;width:36px;height:36px}
.nav{display:flex;gap:12px;align-items:center}
.nav span{padding:6px 10px;border-radius:8px}
.nav .active{background:#162b4b;color:#fff}
.nav .coming{color:#7b8794}
.container{max-width:900px;margin:28px auto;padding:20px;display:flex;gap:24px;align-items:flex-start}
.col{flex:1}
.card{background:linear-gradient(180deg,rgba(255,255,255,0.03),rgba(255,255,255,0.02));padding:18px;border-radius:14px;border:1px solid rgba(255,255,255,0.03);}
input[type=text]{width:100%;padding:12px;border-radius:10px;border:1px solid rgba(255,255,255,0.06);background:#0f1720;color:#fff;margin-bottom:8px}
.btn{display:inline-flex;align-items:center;gap:8px;padding:10px 14px;border-radius:10px;background:#4e8cff;color:#041a34;border:none;cursor:pointer}
.btn.ghost{background:transparent;border:1px solid rgba(255,255,255,0.04)}
.btn.red{background:#ff5b5b;color:#fff}
.small{font-size:13px;color:#9aa4b2}
#interfaceCall{position:fixed;left:50%;top:50%;transform:translate(-50%,-50%);min-width:320px;background:#0f1720;padding:22px;border-radius:14px;box-shadow:0 10px 30px rgba(0,0,0,0.6);display:none;z-index:999}
#callStatus{font-size:18px;margin:0 0 8px 0}
#timer{font-weight:700;color:#4e8cff;margin-bottom:12px;font-size:18px}
.controls{display:flex;gap:12px;justify-content:center}
.controls .btn{border-radius:999px;padding:12px 16px;font-size:14px;display:inline-flex;align-items:center;gap:10px}
#notifications{position:fixed;right:18px;top:18px;width:320px;display:flex;flex-direction:column;gap:10px;z-index:1000}
.notification{background:#0b1014;padding:12px 14px;border-radius:12px;border-left:4px solid #4e8cff;color:#e6eef8;box-shadow:0 6px 18px rgba(0,0,0,0.6)}
#history{display:flex;flex-direction:column;gap:10px;margin-top:8px}
#history button{background:#071022;padding:10px;border-radius:10px;border:1px solid rgba(255,255,255,0.03);text-align:left;color:#dfeaf7;cursor:pointer}
.row{display:flex;gap:12px;align-items:center;margin-top:10px}
.range{width:100%}
@media (max-width:800px){ .container{flex-direction:column;padding:12px} #notifications{right:10px;width:280px} #interfaceCall{min-width:260px} }
</style>
</head>
<body>

<header>
  <div class="logo"><div class="badge"><i class="fa fa-phone"></i></div>Ultra Call</div>
  <div class="nav"><span class="active">Appels</span><span class="coming">Messages (Coming Soon)</span></div>
</header>

<main class="container">
  <section class="col card">
    <h3>Ton code d'ami</h3>
    <input id="myCode" type="text" placeholder="Ex: KIAN123" />
    <button id="registerBtn" class="btn"><i class="fa fa-user-plus"></i> Enregistrer</button>

    <h3 style="margin-top:18px">Appeler un ami</h3>
    <input id="friendCode" type="text" placeholder="Code ami" />
    <button id="callBtn" class="btn"><i class="fa fa-phone"></i> Appeler</button>
  </section>

  <aside class="col card">
    <h3>Historique</h3>
    <div id="history"></div>
  </aside>
</main>

<div id="interfaceCall">
  <div id="callStatus">Appel en cours...</div>
  <div id="timer">00:00</div>
  <div class="controls">
    <button id="hangupBtn" class="btn red"><i class="fa fa-phone-slash"></i></button>
    <button id="muteBtn" class="btn"><i class="fa fa-microphone"></i></button>
  </div>
</div>

<div id="notifications"></div>

<audio id="remoteAudio" autoplay></audio>
<audio id="ringtone" src="sonnerie.mp3" loop></audio>

<script>
/* ==== Variables ==== */
let myCode = "";
let callWith = null;
let pc = null;
let localStream = null;
let isMuted = false;
let seconds = 0, timer=null;
const ws = new WebSocket((location.protocol==="https:"?"wss://":"ws://")+location.host+"/ws");

/* ==== Elements ==== */
const myCodeInput=document.getElementById("myCode");
const registerBtn=document.getElementById("registerBtn");
const friendCodeInput=document.getElementById("friendCode");
const callBtn=document.getElementById("callBtn");
const notifications=document.getElementById("notifications");
const interfaceCall=document.getElementById("interfaceCall");
const callStatus=document.getElementById("callStatus");
const timerEl=document.getElementById("timer");
const hangupBtn=document.getElementById("hangupBtn");
const muteBtn=document.getElementById("muteBtn");
const remoteAudio=document.getElementById("remoteAudio");
const ringtone=document.getElementById("ringtone");

/* ==== Ringtone ==== */
function playRingtone(){ ringtone.currentTime=0; ringtone.volume=0.5; ringtone.play().catch(()=>{}); }
function stopRingtone(){ ringtone.pause(); ringtone.currentTime=0; }

/* ==== UI ==== */
function showNotif(txt){
  const d=document.createElement("div");
  d.className="notification";
  d.innerHTML=txt;
  notifications.prepend(d);
  setTimeout(()=>d.remove(),5000);
}
function showInterface(txt){ interfaceCall.style.display="block"; callStatus.textContent=txt; }
function hideInterface(){ interfaceCall.style.display="none"; stopTimer(); }

/* ==== Timer ==== */
function startTimer(){seconds=0;timerEl.textContent="00:00";timer=setInterval(()=>{seconds++;let m=String(Math.floor(seconds/60)).padStart(2,"0");let s=String(seconds%60).padStart(2,"0");timerEl.textContent=`${m}:${s}`},1000);}
function stopTimer(){if(timer)clearInterval(timer);timerEl.textContent="00:00";}

/* ==== WebRTC ==== */
async function getStream(){
  if(localStream) return localStream;
  localStream=await navigator.mediaDevices.getUserMedia({audio:true});
  return localStream;
}
async function startCall(isCaller){
  await getStream();
  pc=new RTCPeerConnection({iceServers:[{urls:"stun:stun.l.google.com:19302"}]});
  pc.ontrack=(e)=>{remoteAudio.srcObject=e.streams[0];startTimer();};
  pc.onicecandidate=(e)=>{if(e.candidate) ws.send(JSON.stringify({cmd:"signal",target:callWith,payload:{candidate:e.candidate},from:myCode}));};
  localStream.getTracks().forEach(t=>pc.addTrack(t,localStream));
  if(isCaller){
    const offer=await pc.createOffer();await pc.setLocalDescription(offer);
    ws.send(JSON.stringify({cmd:"signal",target:callWith,payload:{sdp:pc.localDescription},from:myCode}));
  }
}
async function handleSignal(payload,from){
  if(!pc) await startCall(false);
  if(payload.sdp){
    await pc.setRemoteDescription(payload.sdp);
    if(payload.sdp.type==="offer"){const ans=await pc.createAnswer();await pc.setLocalDescription(ans);
      ws.send(JSON.stringify({cmd:"signal",target:from,payload:{sdp:pc.localDescription},from:myCode}));}
  }else if(payload.candidate){await pc.addIceCandidate(payload.candidate);}
}

/* ==== WS ==== */
ws.onmessage=async(ev)=>{
  const msg=JSON.parse(ev.data);
  if(msg.type==="registered"){myCode=msg.code;showNotif("Code enregistré: "+msg.code);}
  if(msg.type==="incoming-call"){callWith=msg.from;playRingtone();showNotif(`${msg.from} t'appelle <br><button onclick="answer('${msg.from}')">Répondre</button> <button onclick="reject('${msg.from}')">Raccrocher</button>`);}
  if(msg.type==="call-accepted"){stopRingtone();callWith=msg.with;showInterface("Appel connecté");if(!pc)startCall(true);}
  if(msg.type==="signal"){await handleSignal(msg.payload,msg.from);}
  if(msg.type==="call-ended"){stopRingtone();hideInterface();location.reload();}
};

/* ==== Actions ==== */
registerBtn.onclick=()=>{myCode=myCodeInput.value.trim();ws.send(JSON.stringify({cmd:"register",code:myCode}));};
callBtn.onclick=()=>{callWith=friendCodeInput.value.trim();ws.send(JSON.stringify({cmd:"call",target:callWith,from:myCode}));showInterface("Appel en cours...");};
window.answer=(from)=>{stopRingtone();callWith=from;ws.send(JSON.stringify({cmd:"answer",from}));startCall(false);showInterface("Appel connecté");};
window.reject=(from)=>{stopRingtone();ws.send(JSON.stringify({cmd:"reject",from}));hideInterface();};

/* ==== Hangup ==== */
hangupBtn.onclick=()=>{ws.send(JSON.stringify({cmd:"hangup",target:callWith,from:myCode}));location.reload();};

/* ==== Mute ==== */
muteBtn.onclick=()=>{
  if(!localStream) return;
  isMuted=!isMuted;
  localStream.getAudioTracks().forEach(t=>t.enabled=!isMuted);
  muteBtn.innerHTML=isMuted?'<i class="fa fa-microphone-slash"></i>':'<i class="fa fa-microphone"></i>';
};
</script>
</body>
</html>
