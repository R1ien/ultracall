<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Ultra Call</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    body {
      margin:0;
      font-family:Arial, sans-serif;
      background:linear-gradient(135deg,#0a0a0a,#1e1e1e);
      color:#fff;
      display:flex;
      flex-direction:column;
      align-items:center;
      justify-content:flex-start;
      height:100vh;
    }
    header {
      width:100%;
      padding:15px;
      background:#111;
      display:flex;
      justify-content:space-between;
      align-items:center;
      box-shadow:0 2px 5px rgba(0,0,0,0.5);
    }
    header h1 {color:#0af;margin:0;}
    header nav span {margin-left:20px;color:#777;}
    main {flex:1;display:flex;flex-direction:column;align-items:center;justify-content:center;}
    input,button {
      padding:10px 15px;
      margin:5px;
      border-radius:8px;
      border:none;
      font-size:16px;
    }
    button {
      background:#0af;color:#fff;cursor:pointer;
      transition:0.3s;
    }
    button:hover {background:#08c;}
    #notifications {
      position:fixed;top:80px;right:20px;z-index:1000;
    }
    .notif {
      background:#222;padding:15px;margin-top:10px;border-radius:10px;
      box-shadow:0 2px 8px rgba(0,0,0,0.6);
    }
    .notif button {
      margin:5px 3px;padding:5px 10px;font-size:14px;
    }
    #callInterface {
      position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);
      background:#111;padding:30px;border-radius:15px;display:none;flex-direction:column;align-items:center;
    }
    #callControls {
      margin-top:20px;display:flex;gap:20px;
    }
    #callControls button {
      border-radius:50%;width:60px;height:60px;font-size:22px;display:flex;align-items:center;justify-content:center;
    }
    #hangupBtn {background:#e00;}
    #muteBtn {background:#444;}
    #callTimer {margin-top:10px;font-size:18px;}
  </style>
</head>
<body>
  <header>
    <h1>Ultra Call</h1>
    <nav>
      <span style="color:#0af">Appels</span>
      <span>Messages (coming soon)</span>
    </nav>
  </header>

  <main>
    <div>
      <input id="myCode" placeholder="Mon code d'ami" readonly>
      <button onclick="saveMyCode()">Enregistrer code</button>
    </div>
    <div>
      <input id="friendCode" placeholder="Code d'ami">
      <button onclick="callFriend()">Appeler</button>
    </div>
    <div id="history"></div>
  </main>

  <div id="notifications"></div>

  <!-- Interface d'appel -->
  <div id="callInterface">
    <div id="callStatus">Appel en cours...</div>
    <div id="callTimer"></div>
    <div id="callControls">
      <button id="muteBtn"><i class="fa fa-microphone"></i></button>
      <button id="hangupBtn"><i class="fa fa-phone"></i></button>
    </div>
  </div>

  <!-- Sonnerie -->
  <audio id="ringtone" src="sonnerie.mp3" loop></audio>

  <script>
    const ws=new WebSocket("wss://"+location.host);
    const notifications=document.getElementById("notifications");
    const callInterface=document.getElementById("callInterface");
    const callStatus=document.getElementById("callStatus");
    const callTimer=document.getElementById("callTimer");
    const hangupBtn=document.getElementById("hangupBtn");
    const muteBtn=document.getElementById("muteBtn");
    const ringtone=document.getElementById("ringtone");

    let pc,localStream,remoteStream,isMuted=false,callWith=null,timerInterval,startTime;

    // === Débloquer la sonnerie au premier clic ===
    document.body.addEventListener('click', () => {
      ringtone.play().then(()=>{ ringtone.pause(); ringtone.currentTime=0; }).catch(()=>{});
    }, { once:true });

    function playRingtone(){ ringtone.currentTime=0; ringtone.play().catch(()=>{}); }
    function stopRingtone(){ ringtone.pause(); ringtone.currentTime=0; }

    // === Notifications ===
    function showNotification(html){
      const div=document.createElement("div");
      div.className="notif";
      div.innerHTML=html;
      notifications.appendChild(div);
      setTimeout(()=>{div.remove();},8000);
    }

    // === WebSocket messages ===
    ws.onmessage=async e=>{
      const msg=JSON.parse(e.data);
      if(msg.type==="welcome"){
        document.getElementById("myCode").value=msg.code;
      }else if(msg.type==="incoming-call"){
        const caller=msg.from;
        playRingtone();
        showNotification(`<strong>${caller} t'appelle</strong><br/>
          <button onclick="answerCall('${caller}')">Répondre</button>
          <button onclick="rejectCall('${caller}')">Raccrocher</button>`);
      }else if(msg.type==="call-rejected"){
        stopRingtone();
        showNotification("Appel rejeté.");
      }else if(msg.type==="call-ended"){
        endCall("L'appel a été raccroché");
      }else if(msg.type==="signal"){
        if(!pc) startCall(false);
        await pc.setRemoteDescription(msg.data);
        if(msg.data.type==="offer"){
          const answer=await pc.createAnswer();
          await pc.setLocalDescription(answer);
          ws.send(JSON.stringify({cmd:"signal",target:msg.from,data:answer}));
        }
      }else if(msg.type==="candidate"){
        if(pc) pc.addIceCandidate(msg.candidate);
      }
    };

    // === Historique ===
    function saveMyCode(){
      const code=document.getElementById("myCode").value;
      localStorage.setItem("myCode",code);
      showNotification("Code sauvegardé");
    }
    function addHistory(code){
      let h=JSON.parse(localStorage.getItem("history")||"[]");
      if(!h.includes(code)) h.push(code);
      localStorage.setItem("history",JSON.stringify(h));
      renderHistory();
    }
    function renderHistory(){
      const h=JSON.parse(localStorage.getItem("history")||"[]");
      document.getElementById("history").innerHTML=h.map(c=>`<div>${c} <button onclick="call('${c}')">Rappeler</button></div>`).join("");
    }
    window.onload=renderHistory;

    // === Appels ===
    async function startCall(isCaller){
      pc=new RTCPeerConnection();
      localStream=await navigator.mediaDevices.getUserMedia({audio:true});
      localStream.getTracks().forEach(t=>pc.addTrack(t,localStream));
      remoteStream=new MediaStream();
      pc.ontrack=e=>{remoteStream.addTrack(e.track); new Audio().srcObject=remoteStream;};
      pc.onicecandidate=e=>{
        if(e.candidate) ws.send(JSON.stringify({cmd:"candidate",target:callWith,candidate:e.candidate}));
      };
      if(isCaller){
        const offer=await pc.createOffer();
        await pc.setLocalDescription(offer);
        ws.send(JSON.stringify({cmd:"signal",target:callWith,data:offer}));
      }
    }

    function callFriend(){
      const code=document.getElementById("friendCode").value.trim();
      if(code){ call(code); }
    }
    function call(code){
      callWith=code;
      ws.send(JSON.stringify({cmd:"call",target:code}));
      startCall(true);
      showInterfaceCall(true,"Appel en cours...");
      addHistory(code);
    }
    function answerCall(from){
      stopRingtone();
      ws.send(JSON.stringify({cmd:"answer",from}));
      callWith=from;
      startCall(false);
      addHistory(from);
      showInterfaceCall(true,"Appel connecté");
    }
    function rejectCall(from){
      stopRingtone();
      ws.send(JSON.stringify({cmd:"reject",from}));
    }

    // === Interface appel ===
    function showInterfaceCall(show,text){
      callInterface.style.display=show?"flex":"none";
      callStatus.textContent=text||"";
      if(show){ startTimer(); } else { stopTimer(); }
    }
    function startTimer(){
      startTime=Date.now();
      timerInterval=setInterval(()=>{
        const s=Math.floor((Date.now()-startTime)/1000);
        const m=Math.floor(s/60);
        callTimer.textContent=`${m}:${(s%60).toString().padStart(2,"0")}`;
      },1000);
    }
    function stopTimer(){ clearInterval(timerInterval); callTimer.textContent=""; }

    function endCall(message){
      stopRingtone();
      if(pc){ pc.close(); pc=null; }
      callWith=null;
      stopTimer();
      showInterfaceCall(false);
      showNotification(message);
      setTimeout(()=>location.reload(),1000);
    }

    // === Boutons ===
    hangupBtn.onclick=()=>{
      ws.send(JSON.stringify({cmd:"hangup",target:callWith}));
      location.reload();
    };

    muteBtn.onclick=()=>{
      if(!localStream) return;
      isMuted=!isMuted;
      localStream.getAudioTracks().forEach(t=>t.enabled=!isMuted);
      const icon=muteBtn.querySelector('i');
      if(isMuted){
        icon.classList.remove("fa-microphone");
        icon.classList.add("fa-microphone-slash");
      } else {
        icon.classList.remove("fa-microphone-slash");
        icon.classList.add("fa-microphone");
      }
    };
  </script>
</body>
</html>
