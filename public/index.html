<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Appel vocal entre amis</title>
<style>
body {
  font-family: 'Segoe UI', sans-serif;
  background: #f2f5f7;
  color: #333;
  margin:0;padding:0;
}
header {background:#4e8cff;color:#fff;padding:15px;text-align:center;font-size:1.5em;}
.container {padding:20px;max-width:800px;margin:auto;}
button,input{padding:8px 12px;margin:4px;border-radius:6px;border:1px solid #ccc;font-size:1em;}
button{background:#4e8cff;color:#fff;border:none;cursor:pointer;transition:0.2s;}
button:hover{background:#3a6fdc;}
input{width:140px;}
#history {margin-top:15px;}
#notifications {position:fixed;top:10px;right:10px;width:300px;z-index:999;}
.notification{background:#fff;border:1px solid #ccc;padding:10px;margin-bottom:10px;border-radius:8px;box-shadow:0 2px 6px rgba(0,0,0,0.2);}
.slider-container {margin-top:12px;}
label{display:block;margin-top:6px;font-size:0.9em;}
#callControls {margin-top:15px; display:none;}
#callControls button{margin-right:10px;}
</style>
</head>
<body>

<header>Appel vocal entre amis</header>
<div class="container">
  <h3>Ton code d'ami :</h3>
  <input id="myCode" placeholder="Ex: ABC123" />
  <button id="registerBtn">Enregistrer</button>

  <h3>Appeler un ami :</h3>
  <input id="friendCode" placeholder="Code ami"/>
  <button id="callBtn">Appeler</button>

  <div class="slider-container">
    <label>Volume reçu: <span id="remoteVal">100%</span></label>
    <input id="remoteGain" type="range" min="0" max="200" value="100" />
  </div>

  <div class="slider-container">
    <label>Amplifier mon micro:</label>
    <input type="checkbox" id="applyLocalGain" />
    <label>Gain micro local: <span id="localVal">100%</span></label>
    <input type="range" id="localGain" min="0" max="200" value="100"/>
  </div>

  <div id="callControls">
    <button id="hangupBtn">Raccrocher</button>
    <button id="muteBtn">Couper micro</button>
  </div>

  <h3>Historique des appels :</h3>
  <ul id="history"></ul>
</div>

<div id="notifications"></div>

<audio id="remoteAudio" autoplay></audio>

<script>
const ws = new WebSocket((location.protocol==='https:'?'wss://':'ws://')+location.host+'/ws');

let pc=null, localStream=null, remoteStream=null;
let audioCtxRemote=null, remoteGainNode=null;
let localAudioContext=null, localGainNode=null, localSourceNode=null, localDestination=null;
let callWith=null, myCode='', isMuted=false;

// UI
const myCodeInput=document.getElementById('myCode');
const registerBtn=document.getElementById('registerBtn');
const friendCodeInput=document.getElementById('friendCode');
const callBtn=document.getElementById('callBtn');
const historyList=document.getElementById('history');
const notificationsDiv=document.getElementById('notifications');
const remoteGainSlider=document.getElementById('remoteGain');
const remoteVal=document.getElementById('remoteVal');
const applyLocalGainChk=document.getElementById('applyLocalGain');
const localGainSlider=document.getElementById('localGain');
const localVal=document.getElementById('localVal');
const callControls=document.getElementById('callControls');
const hangupBtn=document.getElementById('hangupBtn');
const muteBtn=document.getElementById('muteBtn');
const remoteAudio=document.getElementById('remoteAudio');

const ICE_SERVERS = [{ urls: 'stun:stun.l.google.com:19302' }];

// ===================
// Historique
// ===================
function addHistory(code){
  let list = JSON.parse(localStorage.getItem('callHistory')||'[]');
  if(!list.includes(code)) list.push(code);
  localStorage.setItem('callHistory', JSON.stringify(list));
  renderHistory();
}
function renderHistory(){
  historyList.innerHTML='';
  let list = JSON.parse(localStorage.getItem('callHistory')||'[]');
  list.forEach(code=>{
    const li=document.createElement('li');
    const btn=document.createElement('button');
    btn.textContent='Appeler '+code;
    btn.onclick=()=>callFriend(code);
    li.appendChild(btn);
    historyList.appendChild(li);
  });
}

// ===================
// Notifications
// ===================
function showNotification(html){
  const n=document.createElement('div');
  n.className='notification';
  n.innerHTML=html;
  notificationsDiv.appendChild(n);
  setTimeout(()=>notificationsDiv.removeChild(n),10000);
}

// ===================
// WebSocket
// ===================
ws.onmessage=async ev=>{
  const msg=JSON.parse(ev.data);
  if(msg.type==='registered'){
    myCode=msg.code;
    localStorage.setItem('myCode', myCode);
    showNotification('Code enregistré: '+myCode);
  }
  else if(msg.type==='incoming-call'){
    const caller=msg.from;
    showNotification(`<strong>${caller} t'appelle</strong><br/>
      <button onclick="answerCall('${caller}')">Répondre</button>
      <button onclick="rejectCall('${caller}')">Raccrocher</button>`);
  }
  else if(msg.type==='call-accepted'){
    callWith=msg.with;
    showNotification('Appel accepté avec '+callWith);
    startCall(true);
    addHistory(callWith);
    showCallControls(true);
  }
  else if(msg.type==='call-rejected'){
    showNotification('Ton appel a été refusé par '+msg.from);
  }
  else if(msg.type==='signal'){
    handleSignal(msg.payload);
  }
};

// ===================
// Buttons
// ===================
registerBtn.onclick=()=>{
  const c=myCodeInput.value.trim();
  if(!c) return alert('Tape ton code');
  ws.send(JSON.stringify({cmd:'register', code:c}));
};
callBtn.onclick=()=>{ const c=friendCodeInput.value.trim(); if(!c) return alert('Tape un code ami'); callFriend(c);}
function callFriend(code){
  ws.send(JSON.stringify({cmd:'call', target:code}));
  addHistory(code);
}

// ===================
// Answer / reject
// ===================
function answerCall(from){
  ws.send(JSON.stringify({cmd:'answer', from}));
  callWith=from;
  startCall(false);
  addHistory(from);
  showCallControls(true);
}
function rejectCall(from){ ws.send(JSON.stringify({cmd:'reject', from})); }

// ===================
// WebRTC
// ===================
async function startCall(isCaller){
  if(!localStream){
    localStream=await navigator.mediaDevices.getUserMedia({audio:true});
  }
  pc=new RTCPeerConnection({iceServers:ICE_SERVERS});
  pc.ontrack=e=>{
    remoteStream=e.streams[0];
    remoteAudio.srcObject=remoteStream;
  };
  pc.onicecandidate=e=>{ if(e.candidate) ws.send(JSON.stringify({cmd:'signal', target:callWith, payload:{candidate:e.candidate}})); };

  // Ajouter les pistes locales à chaque fois
  localStream.getTracks().forEach(track=>pc.addTrack(track, localStream));

  if(isCaller){
    const offer=await pc.createOffer();
    await pc.setLocalDescription(offer);
    ws.send(JSON.stringify({cmd:'signal', target:callWith, payload:{sdp:pc.localDescription}}));
  }
}
async function handleSignal(payload){
  if(!pc) await startCall(false);
  if(payload.sdp){
    await pc.setRemoteDescription(payload.sdp);
    if(payload.sdp.type==='offer'){
      const answer=await pc.createAnswer();
      await pc.setLocalDescription(answer);
      ws.send(JSON.stringify({cmd:'signal', target:callWith, payload:{sdp:pc.localDescription}}));
    }
  }else if(payload.candidate){
    try{ await pc.addIceCandidate(payload.candidate);} catch{}
  }
}

// ===================
// Call Controls
// ===================
function showCallControls(show){ callControls.style.display=show?'block':'none'; }
hangupBtn.onclick=()=>{ if(pc){ pc.close(); pc=null;} callWith=null; showCallControls(false); showNotification('Appel terminé'); };
muteBtn.onclick=()=>{ if(!localStream) return; isMuted=!isMuted; localStream.getAudioTracks().forEach(t=>t.enabled=!isMuted); muteBtn.textContent=isMuted?'Micro coupé':'Couper micro'; };

// ===================
// Sliders
// ===================
remoteGainSlider.oninput=()=>{ remoteVal.textContent=remoteGainSlider.value+'%'; if(remoteAudio) remoteAudio.volume=remoteGainSlider.value/100; };
localGainSlider.oninput=()=>{ localVal.textContent=localGainSlider.value+'%'; };

// ===================
// Init
// ===================
window.addEventListener('load',()=>{
  const saved=localStorage.getItem('myCode');
  if(saved){ myCodeInput.value=saved; myCode=saved; ws.addEventListener('open',()=>ws.send(JSON.stringify({cmd:'register', code:saved}))); }
  renderHistory();
});
</script>
</body>
</html>
