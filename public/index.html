<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Ultra Call</title>
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
<style>
body,html{margin:0;padding:0;font-family:'Segoe UI',sans-serif;background:linear-gradient(135deg,#111,#1a1a1a);color:#fff;height:100%;}
header{display:flex;align-items:center;justify-content:space-between;padding:15px 20px;background:#0d0d0d;border-bottom:1px solid #333;}
header .logo{font-size:1.8em;font-weight:bold;color:#4e8cff;}
header .nav{display:flex;gap:20px;}
header .nav span{cursor:pointer;padding:5px 10px;border-radius:6px;}
header .nav .active{background:#4e8cff;color:#fff;}
header .nav .coming{color:#888;}
.container{max-width:800px;margin:20px auto;padding:0 20px;}
input,button{border:none;outline:none;font-size:1em;}
input{padding:10px 12px;border-radius:8px;margin:5px 0;width:calc(100% - 24px);background:#222;color:#fff;}
button{padding:10px 15px;border-radius:8px;margin:5px 5px 5px 0;background:#4e8cff;color:#fff;cursor:pointer;transition:0.2s;}
button:hover{background:#3a6fdc;}
.slider-container{margin:12px 0;}
.slider-container input[type=range]{width:100%;}
#callInterface{position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);background:#1a1a1a;padding:30px;border-radius:15px;text-align:center;display:none;min-width:280px;}
#callInterface h2{margin-bottom:20px;font-size:1.5em;}
#callInterface .controls{display:flex;justify-content:center;gap:20px;margin-top:20px;}
#callInterface button{display:flex;align-items:center;gap:8px;}
#callInterface button .fa{font-size:1.2em;}
#history{margin-top:15px;display:flex;flex-direction:column;gap:8px;}
#history button{background:#333;color:#fff;width:100%;text-align:left;transition:0.2s;}
#history button:hover{background:#4e8cff;color:#fff;}
</style>
</head>
<body>

<header>
  <div class="logo"><i class="fa fa-phone"></i> Ultra Call</div>
  <div class="nav">
    <span class="active">Appels</span>
    <span class="coming">Messages (Coming Soon)</span>
  </div>
</header>

<div class="container">
  <h3>Ton code d'ami :</h3>
  <input id="myCode" placeholder="Ex: ABC123" />
  <button id="registerBtn"><i class="fa fa-user-plus"></i> Enregistrer</button>

  <h3>Appeler un ami :</h3>
  <input id="friendCode" placeholder="Code ami"/>
  <button id="callBtn"><i class="fa fa-phone"></i> Appeler</button>

  <div class="slider-container">
    <label>Volume reçu: <span id="remoteVal">100%</span></label>
    <input id="remoteGain" type="range" min="0" max="200" value="100" />
  </div>

  <div class="slider-container">
    <label>Amplifier mon micro:</label>
    <input type="checkbox" id="applyLocalGain" /> Activer
    <label>Gain micro local: <span id="localVal">100%</span></label>
    <input type="range" id="localGain" min="0" max="200" value="100"/>
  </div>

  <h3>Historique des appels :</h3>
  <ul id="history"></ul>
</div>

<div id="callInterface">
  <h2 id="callStatus">Appel en cours...</h2>
  <div id="callTimer">00:00</div>
  <div class="controls">
    <button id="hangupBtn" style="background:#ff4d4d;"><i class="fa fa-phone-slash"></i> Raccrocher</button>
    <button id="muteBtn" style="background:#ffa500;"><i class="fa fa-microphone"></i> Couper micro</button>
  </div>
</div>

<audio id="remoteAudio" autoplay></audio>

<script>
const ws = new WebSocket((location.protocol==='https:'?'wss://':'ws://')+location.host+'/ws');

let pc=null, localStream=null, remoteStream=null;
let callWith=null, myCode='', isMuted=false;
let callStart=null, timerInterval=null;

// UI
const myCodeInput=document.getElementById('myCode');
const registerBtn=document.getElementById('registerBtn');
const friendCodeInput=document.getElementById('friendCode');
const callBtn=document.getElementById('callBtn');
const historyList=document.getElementById('history');
const remoteGainSlider=document.getElementById('remoteGain');
const remoteVal=document.getElementById('remoteVal');
const applyLocalGainChk=document.getElementById('applyLocalGain');
const localGainSlider=document.getElementById('localGain');
const localVal=document.getElementById('localVal');
const callInterface=document.getElementById('callInterface');
const callStatus=document.getElementById('callStatus');
const callTimer=document.getElementById('callTimer');
const hangupBtn=document.getElementById('hangupBtn');
const muteBtn=document.getElementById('muteBtn');
const remoteAudio=document.getElementById('remoteAudio');

// =================== Historique ===================
function addHistory(code){
  let list = JSON.parse(localStorage.getItem('callHistory')||'[]');
  if(!list.includes(code)) list.push(code);
  localStorage.setItem('callHistory', JSON.stringify(list));
  renderHistory();
}
function renderHistory(){
  historyList.innerHTML='';
  let list = JSON.parse(localStorage.getItem('callHistory')||'[]');
  list.forEach(code=>{
    const li=document.createElement('li');
    const btn=document.createElement('button');
    btn.innerHTML='<i class="fa fa-phone"></i> '+code;
    btn.onclick=()=>callFriend(code);
    li.appendChild(btn);
    historyList.appendChild(li);
  });
}

// =================== WebSocket ===================
ws.onmessage=async ev=>{
  const msg=JSON.parse(ev.data);
  if(msg.type==='registered'){ myCode=msg.code; localStorage.setItem('myCode', myCode);}
  else if(msg.type==='incoming-call'){ 
    const caller=msg.from;
    startInterface(caller,'incoming');
  }
  else if(msg.type==='call-accepted'){ callWith=msg.with; startCall(true); addHistory(callWith);}
  else if(msg.type==='call-rejected'){ alert('Ton appel a été refusé'); }
  else if(msg.type==='signal'){ handleSignal(msg.payload); }
};

// =================== Buttons ===================
registerBtn.onclick=()=>{ const c=myCodeInput.value.trim(); if(!c) return alert('Tape ton code'); ws.send(JSON.stringify({cmd:'register', code:c})); }
callBtn.onclick=()=>{ const c=friendCodeInput.value.trim(); if(!c) return alert('Tape un code ami'); callFriend(c);}
function callFriend(code){ ws.send(JSON.stringify({cmd:'call', target:code})); addHistory(code); startInterface(code,'calling'); }

// =================== Interface centrale ===================
function startInterface(code,type){
  callInterface.style.display='block';
  if(type==='calling'){ callStatus.textContent='Appel en cours...'; startTimer(false); }
  else if(type==='incoming'){ callStatus.textContent=`${code} t'appelle...`; callTimer.textContent='00:00'; }
}

// Timer
function startTimer(startNow){
  clearInterval(timerInterval);
  callStart = startNow?Date.now():null;
  if(!callStart) return;
  timerInterval=setInterval(()=>{
    const diff=Math.floor((Date.now()-callStart)/1000);
    const m=Math.floor(diff/60).toString().padStart(2,'0');
    const s=(diff%60).toString().padStart(2,'0');
    callTimer.textContent=`${m}:${s}`;
  },1000);
}

// =================== Answer / Reject ===================
function answerCall(from){ ws.send(JSON.stringify({cmd:'answer', from})); callWith=from; startCall(false); addHistory(from); callStatus.textContent='Appel en cours...'; startTimer(true);}
function rejectCall(from){ ws.send(JSON.stringify({cmd:'reject', from})); callInterface.style.display='none';}

// =================== WebRTC ===================
async function startCall(isCaller){
  if(!localStream){ localStream=await navigator.mediaDevices.getUserMedia({audio:true}); }
  pc=new RTCPeerConnection({iceServers:[{urls:'stun:stun.l.google.com:19302'}]});
  pc.ontrack=e=>{ remoteStream=e.streams[0]; remoteAudio.srcObject=remoteStream; }
  pc.onicecandidate=e=>{ if(e.candidate) ws.send(JSON.stringify({cmd:'signal', target:callWith, payload:{candidate:e.candidate}})); }
  localStream.getTracks().forEach(track=>pc.addTrack(track, localStream));
  if(isCaller){ const offer=await pc.createOffer(); await pc.setLocalDescription(offer); ws.send(JSON.stringify({cmd:'signal', target:callWith, payload:{sdp:pc.localDescription}})); }
}
async function handleSignal(payload){ if(!pc) await startCall(false); if(payload.sdp){ await pc.setRemoteDescription(payload.sdp); if(payload.sdp.type==='offer'){ const answer=await pc.createAnswer(); await pc.setLocalDescription(answer); ws.send(JSON.stringify({cmd:'signal', target:callWith, payload:{sdp:pc.localDescription}})); startTimer(true);} } else if(payload.candidate){ try{ await pc.addIceCandidate(payload.candidate);} catch{} }}

// =================== Call Controls ===================
hangupBtn.onclick=()=>{ if(pc){ pc.close(); pc=null;} callWith=null; callInterface.style.display='none'; clearInterval(timerInterval); callTimer.textContent='00:00'; }
muteBtn.onclick=()=>{ if(!localStream) return; isMuted=!isMuted; localStream.getAudioTracks().forEach(t=>t.enabled=!isMuted); muteBtn.innerHTML=isMuted?'<i class="fa fa-microphone-slash"></i> Micro coupé':'<i class="fa fa-microphone"></i> Couper micro';}

// =================== Sliders ===================
remoteGainSlider.oninput=()=>{ remoteVal.textContent=remoteGainSlider.value+'%'; if(remoteAudio) remoteAudio.volume=remoteGainSlider.value/100; }
localGainSlider.oninput=()=>{ localVal.textContent=localGainSlider.value+'%'; }

// =================== Init ===================
window.addEventListener('load',()=>{
  const saved=localStorage.getItem('myCode'); if(saved){ myCodeInput.value=saved; myCode=saved; ws.addEventListener('open',()=>ws.send(JSON.stringify({cmd:'register', code:saved}))); }
  renderHistory();
});
</script>
</body>
</html>
